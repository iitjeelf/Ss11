<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>LFJC Online Exam</title>
<style>
body{font-family:"SF Pro Display",Arial,sans-serif;margin:0;background:#fff;color:#000;overflow-x:hidden;}
header{background:linear-gradient(145deg,#E6E6FA,#D8BFD8);color:#4B0082;text-align:center;padding:20px;font-size:36px;font-weight:700;letter-spacing:1.5px;box-shadow:0 5px #aaa;text-shadow:0 1px 2px #fff;}
#studentEntry,#examArea{padding:20px;text-align:center;}
.form-group{display:flex;flex-direction:row;align-items:center;justify-content:center;margin-bottom:15px;}
.form-group label{font-size:1.15rem;font-weight:600;margin-right:10px;color:#4B0082;width:120px;text-align:right;}
input[type="text"]{padding:10px 12px;font-size:1.1rem;border-radius:10px;border:1.5px solid #4B0082;outline:none;min-width:250px;}
input.error{animation:glowRed 0.5s alternate infinite;border-color:red;}
@keyframes glowRed{0%{box-shadow:0 0 5px red;}100%{box-shadow:0 0 15px red;}}
button{position:relative;overflow:hidden;cursor:pointer;border:none;border-radius:12px;transition:all .18s ease;box-shadow:0 6px #aaa;background:linear-gradient(to bottom,#fafaff,#dcd6f7);color:#4B0082;font-weight:600;padding:10px 20px;font-size:18px;}
button:hover{transform:translateY(-2px);box-shadow:0 8px 15px rgba(0,0,0,.28);}
button:active{transform:translateY(3px) scale(.98);}
.optBtn{font-size:16px;padding:8px 18px;margin:6px;border:2px solid #4B0082;background:#fff;border-radius:8px;box-shadow:0 5px #aaa;}
.optBtn.selected{background:#32CD32;color:#fff;border-color:#2fa92f;}
.navContainer{display:flex;justify-content:center;gap:10px;margin:10px 0;flex-wrap:wrap}
.navBtn{font-size:16px;padding:10px 20px;border-radius:8px;color:#fff;font-weight:bold;cursor:pointer;background:linear-gradient(145deg,#1E90FF,#4682B4);}
#markReviewBtn{background:linear-gradient(145deg,#ffb84d,#ff9900)}
#submitBtn{background:linear-gradient(145deg,#c8b88a,#b49e60)}
#timerEl{font-size:20px;font-weight:bold;color:#4B0082;padding:6px 12px;border-radius:6px;background:#f0f0ff;display:inline-block;transition:all 0.3s ease;}
#timerEl.blink{animation:blinkTimer 1s infinite;}
@keyframes blinkTimer{0%{background:#ff6666;color:#fff;}50%{background:#fff;color:#4B0082;}100%{background:#ff6666;color:#fff;}}
#paletteContainer button{width:36px;height:36px;border-radius:50%;font-size:14px;margin:3px;border:1px solid #4B0082;background:#E6E6FA;color:#4B0082;}
#paletteContainer button.selected{background:#32CD32;color:#fff;border-color:#2fa92f}
#paletteContainer button.reviewed{background:yellow;color:#000}
#paletteContainer button.current{border:3px solid red}
footer{background:#E6E6FA;color:#4B0082;padding:10px;text-align:center;font-weight:bold;position:fixed;width:100%;bottom:0;}
.sectionTitle{font-size:22px;color:#4B0082;font-weight:bold;margin-bottom:8px;}
img.questionImg{max-width:90%;border-radius:10px;transform:scale(1.1);transition:transform .2s ease;}
img.questionImg:hover{transform:scale(1.15);}
@media(max-width:600px){
.form-group{flex-direction:column;align-items:flex-start;}
.form-group label{text-align:left;width:auto;margin-bottom:5px;}
}
#lockOverlay{position:fixed;top:0;left:0;width:100%;height:100%;background:red;z-index:9999;display:none;align-items:center;justify-content:center;flex-direction:column;color:#fff;font-weight:bold;}
#accessMsg{font-size:3rem;margin-bottom:20px;}
#callAdminBtn{background:green;color:#fff;padding:15px 30px;font-size:20px;font-weight:bold;border:none;border-radius:10px;cursor:pointer;box-shadow:0 6px #0003;animation:glowGreen 1s infinite alternate;}
@keyframes glowGreen{0%{box-shadow:0 0 5px #0f0;}100%{box-shadow:0 0 20px #0f0;}}
.redSlice{position:absolute;top:0;bottom:0;width:14.285%;background:red;}
</style>
</head>
<body>
<header>LFJC ONLINE EXAMINATION</header>

<div id="lockOverlay">
  <div id="accessMsg">ACCESS DENIED</div>
  <button id="callAdminBtn">CALL ADMIN</button>
</div>

<div id="studentEntry">
  <div class="form-group"><label>Name</label><input type="text" id="stuName" placeholder="Only letters, spaces & ."></div>
  <div class="form-group"><label>Section</label><input type="text" id="stuSection" placeholder="Letters & digits"></div>
  <div class="form-group"><label>Roll</label><input type="text" id="stuRoll" placeholder="Digits only"></div>
  <div class="form-group"><label>Admission No</label><input type="text" id="stuAdm" placeholder="Digits only"></div>
  <div class="form-group"><button id="stuStartBtn" style="display:none;">Start Exam</button></div>
  <p id="studentMsg"></p>
</div>

<div id="examArea" style="display:none;">
  <div id="examHeader" style="display:flex;justify-content:space-between;align-items:center;">
    <div id="stuInfo" style="text-align:left;font-weight:bold;"></div>
    <div id="stuQInfo" style="text-align:center;"></div>
    <div id="timerEl">ðŸ•’ 00:00</div>
  </div>
  <div id="questionContainer" style="text-align:center;margin-top:10px;"></div>
  <div class="navContainer">
    <button class="navBtn" id="prevBtn">â¬… Previous</button>
    <button class="navBtn" id="markReviewBtn">Review</button>
    <button class="navBtn" id="nextBtn">Next âž¡</button>
    <button class="navBtn" id="submitBtn">Submit Exam</button>
  </div>
  <div id="paletteContainer"></div>
</div>

<footer>LFJC@2025 All rights reserved</footer>

<script>
const SHEET_URL="https://script.google.com/macros/s/AKfycbz1DVbfKyBz1Q8QMrhJOwUK3maEqXyrL50A4cGLmcIzfNO8VVGT3oSJ651laosOgCAm/exec";
let images=["1.png","2.png","3.png","4.png","5.png","6.png"];
let answerKey=["A","B","C","D","A","B"];
let examData={files:images.map(img=>({data:img}))};
let progress=null,timerInterval=null;
const nameRe=/^[A-Za-z .]+$/;

// Lock check
const lockKey="lfjc_lock";
const lockData=JSON.parse(localStorage.getItem(lockKey)||"{}");
const now=Date.now();
if(lockData.time && now-lockData.time<86400000){
  showLockOverlay();
}
function showLockOverlay(){
  const overlay=document.getElementById("lockOverlay");
  overlay.style.display="flex";
  const slices=[];
  for(let i=0;i<7;i++){
    const s=document.createElement("div");
    s.className="redSlice";
    s.style.left=(i*14.285)+"%";
    overlay.appendChild(s);
    slices.push(s);
  }
  const callBtn=document.getElementById("callAdminBtn");
  callBtn.onclick=()=>{
    let code="lfjc2025",index=0;
    document.addEventListener("keydown",function(e){
      if(e.key.toLowerCase()===code[index]){slices[index].style.background="transparent";index++;
        if(index===code.length){overlay.style.display="none";localStorage.removeItem(lockKey);}
      }
    });
  };
}

// Validate
function validateStudentInputs(){
  const n=document.getElementById('stuName');
  const s=document.getElementById('stuSection');
  const r=document.getElementById('stuRoll');
  const a=document.getElementById('stuAdm');
  let vn=nameRe.test(n.value);
  let vs=/^[A-Za-z0-9]+$/.test(s.value);
  let vr=/^[0-9]+$/.test(r.value);
  let va=/^[0-9]+$/.test(a.value);
  n.classList.toggle('error',!vn&&n.value!=="");
  s.classList.toggle('error',!vs&&s.value!=="");
  r.classList.toggle('error',!vr&&r.value!=="");
  a.classList.toggle('error',!va&&a.value!=="");
  const allValid=vn&&vs&&vr&&va;
  document.getElementById('stuStartBtn').style.display=allValid?'inline-block':'none';
  return allValid;
}
['stuName','stuSection','stuRoll','stuAdm'].forEach(id=>document.getElementById(id).addEventListener('input',validateStudentInputs));

document.getElementById('stuStartBtn').onclick=()=>{
  const name=document.getElementById('stuName').value.trim();
  const sec=document.getElementById('stuSection').value.trim();
  const roll=document.getElementById('stuRoll').value.trim();
  const adm=document.getElementById('stuAdm').value.trim();
  const key=name+"_"+sec+"_"+roll+"_"+adm;
  localStorage.setItem(lockKey,JSON.stringify({id:key,time:Date.now()}));
  progress={answers:Array(examData.files.length).fill(null),review:Array(examData.files.length).fill(false),currentIndex:0,student:{name,sec,roll,adm},timeLeftSec:5*60};
  document.getElementById('studentEntry').style.display='none';
  document.getElementById('examArea').style.display='block';
  renderQuestion();renderPalette();startTimer();
};

function startTimer(){
  const timerEl=document.getElementById('timerEl');
  const stuInfo=document.getElementById('stuInfo');
  const stuQInfo=document.getElementById('stuQInfo');
  timerInterval=setInterval(()=>{
    if(progress.timeLeftSec<=0){clearInterval(timerInterval);alert("Time's up! Submitting automatically.");submitExam();return;}
    progress.timeLeftSec--;
    const m=Math.floor(progress.timeLeftSec/60);
    const s=progress.timeLeftSec%60;
    timerEl.textContent=`ðŸ•’ ${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    stuInfo.textContent=`${progress.student.name} | Sec: ${progress.student.sec} | Roll: ${progress.student.roll} | Adm: ${progress.student.adm}`;
    stuQInfo.textContent=`Q ${progress.currentIndex+1}/${examData.files.length}`;
    if(progress.timeLeftSec<=300)timerEl.classList.add('blink');else timerEl.classList.remove('blink');
  },1000);
}

function renderQuestion(){
  const q=document.getElementById('questionContainer');
  const file=examData.files[progress.currentIndex];
  const imgTag=`<img src="${file.data}" class="questionImg" alt="Q${progress.currentIndex+1}"><br>`;
  q.innerHTML=imgTag;
  ["A","B","C","D"].forEach(opt=>{
    const btn=document.createElement('button');
    btn.className='optBtn';btn.textContent=opt;
    if(progress.answers[progress.currentIndex]===opt)btn.classList.add('selected');
    btn.onclick=()=>{
      progress.answers[progress.currentIndex]=opt;
      document.querySelectorAll('.optBtn').forEach(b=>b.classList.remove('selected'));
      btn.classList.add('selected');renderPalette();
    };
    q.appendChild(btn);
  });
}
document.getElementById('nextBtn').onclick=()=>{if(progress.currentIndex<examData.files.length-1){progress.currentIndex++;renderQuestion();renderPalette();}};
document.getElementById('prevBtn').onclick=()=>{if(progress.currentIndex>0){progress.currentIndex--;renderQuestion();renderPalette();}};
document.getElementById('markReviewBtn').onclick=()=>{progress.review[progress.currentIndex]=!progress.review[progress.currentIndex];renderPalette();};

function renderPalette(){
  const cont=document.getElementById('paletteContainer');cont.innerHTML='';
  progress.answers.forEach((ans,i)=>{
    const b=document.createElement('button');b.textContent=i+1;
    if(i===progress.currentIndex)b.classList.add('current');
    if(progress.review[i])b.classList.add('reviewed');
    if(ans)b.classList.add('selected');
    b.onclick=()=>{progress.currentIndex=i;renderQuestion();renderPalette();};
    cont.appendChild(b);
  });
}

function sendToSheet(resultData){
  fetch(SHEET_URL,{method:'POST',mode:'no-cors',headers:{'Content-Type':'application/json'},body:JSON.stringify(resultData)});
}

document.getElementById('submitBtn').onclick=()=>{if(confirm("Are you sure you want to submit your exam?"))submitExam();};
function submitExam(){
  clearInterval(timerInterval);
  let correct=0,wrong=0,blank=0;
  for(let i=0;i<examData.files.length;i++){
    const given=progress.answers[i],key=answerKey[i];
    if(!given)blank++;else if(given===key)correct++;else wrong++;
  }
  const total=examData.files.length,marks=correct-wrong*0.25;
  sendToSheet({name:progress.student.name,section:progress.student.sec,roll:progress.student.roll,adm:progress.student.adm,correct,wrong,blank,total,marks,answers:progress.answers});
  document.getElementById('examArea').style.display='none';document.getElementById('studentEntry').style.display='none';
  const r=document.createElement('div');r.id="resultArea";r.style.padding="20px";r.style.textAlign="center";
  r.innerHTML=`<h2>Congratulations ${progress.student.name}!</h2>
  <table border="1" style="margin:auto;border-collapse:collapse;"><tr><th>Section</th><th>Roll</th><th>Adm No</th></tr>
  <tr><td>${progress.student.sec}</td><td>${progress.student.roll}</td><td>${progress.student.adm}</td></tr></table>
  <br><table border="1" style="margin:auto;border-collapse:collapse;">
  <tr><th>Correct</th><th>Wrong</th><th>Blank</th><th>Total</th><th>Score</th><th>%</th></tr>
  <tr><td>${correct}</td><td>${wrong}</td><td>${blank}</td><td>${total}</td><td>${marks.toFixed(2)}</td><td>${((marks/total)*100).toFixed(2)}%</td></tr></table>
  <br><button id="logoutBtn">Logout</button>`;
  document.body.appendChild(r);
  document.getElementById('logoutBtn').onclick=()=>window.close();
}
</script>
</body>
</html>
